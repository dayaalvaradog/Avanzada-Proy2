@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

@{
    ViewData["Title"] = "Repuesto";
}

<h1>Gestión de Especies de Semillas</h1>

<div style="text-align: right;">
    <button class="btn btn-sm btn-success">
        <a class="nav-link text-dark" asp-area="" asp-controller="Especies" asp-action="AgregarFamilia">Agregar Familia</a>
    </button>
    <button class="btn btn-sm btn-success">
        <a class="nav-link text-dark" asp-area="" asp-controller="Especies" asp-action="Agregar">Agregar Especie</a>
    </button>
</div>

<div id="mensajeListaEspecies" class="mt-3"></div>

<table id="especiesTable" class="table table-striped table-hover">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre Científico</th>
            <th>Nombre Común</th>
            <th>Familia</th>
            <th>Descripción</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="especiesTableBody">
    </tbody>
</table>
@section Scripts {
    <script>
        const API_BASE_URL = "@Configuration["AppSettings:ApiBaseUrl"]";
        const API_ESPECIES_URL = `${API_BASE_URL}/api/Especies`;
        const especiesTableBody = document.getElementById('especiesTableBody');
        const mensajeListaEspecies = document.getElementById('mensajeListaEspecies');

        async function loadEspecies() {
            try {
                // Llama al endpoint de tu API para obtener las especies
                const response = await fetch(`${API_ESPECIES_URL}`);

                if (response.ok) {
                    const especies = await response.json();
                    especiesTableBody.innerHTML = '';

                    if (especies.length === 0) {
                        mensajeListaEspecies.className = 'alert alert-info';
                        mensajeListaEspecies.innerHTML = 'No se encontraron especies.';
                        return;
                    }

                    especies.forEach(especie => {
                        const row = `
                            <tr>
                                <td>${especie.idEspecie}</td>
                                <td>${especie.nombreCientifico}</td>
                                <td>${especie.nombreComun}</td>
                                <td>${especie.familia.nombre}</td>
                                <td>${especie.descripcion}</td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-especie" data-id="${especie.idEspecie}">Editar</button>
                                    <button class="btn btn-sm btn-danger delete-especie" data-id="${especie.idEspecie}">Eliminar</button>
                                </td>
                            </tr>
                        `;
                        especiesTableBody.innerHTML += row;
                    });

                    // Configura los eventos de los botones "Editar"
                    document.querySelectorAll('.edit-especie').forEach(button => {
                        button.addEventListener('click', function() {
                            const especieId = this.dataset.id;
                            // Redirigir a la vista de edición
                            window.location.href = `/Especies/Editar/${especieId}`;
                        });
                    });

                    // Configura los eventos de los botones "Eliminar"
                    document.querySelectorAll('.delete-especie').forEach(button => {
                        button.addEventListener('click', async function() {
                            const especieId = this.dataset.id;

                            // Muestra la ventana de confirmación
                            const confirmacion = confirm("¿Estás seguro de que deseas eliminar esta especie?");

                            if (confirmacion) {
                                try {
                                    // Realiza la petición DELETE al API
                                    const API_BASE_URL = "@Configuration["AppSettings:ApiBaseUrl"]";
                                    const apiUrl = `${API_BASE_URL}/api/Especies/${especieId}`;

                                    const response = await fetch(apiUrl, {
                                        method: 'DELETE'
                                    });

                                    if (response.ok) {
                                        alert('Especie eliminada exitosamente.');
                                        // Recarga la página para mostrar los cambios
                                        window.location.reload();
                                    } else {
                                        const errorData = await response.json();
                                        alert('Error al eliminar la especie: ' + JSON.stringify(errorData));
                                        console.error('Error del API:', errorData);
                                    }
                                } catch (error) {
                                    console.error('Error de red al eliminar la especie:', error);
                                    alert('Ocurrió un error de red.');
                                }
                            }
                        });
                    });

                } else {
                    mensajeListaEspecies.className = 'alert alert-danger';
                    mensajeListaEspecies.innerHTML = 'Error al cargar especies.';
                }
            } catch (error) {
                mensajeListaEspecies.className = 'alert alert-danger';
                mensajeListaEspecies.innerHTML = `Ocurrió un error de red: ${error.message}.`;
            }
        }

        loadEspecies();
    </script>
}
