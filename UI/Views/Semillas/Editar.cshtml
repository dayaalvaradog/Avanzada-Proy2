@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@using Core.Entidades
@model SemillaViewModel;

<h2>Editar Semilla</h2>

<form id="EditarSemilla" asp-action="Editar" method="post">
    <div class="form-group">
        <input type="hidden" asp-for="idSemilla" />
        <label>Nombre</label>
        <input asp-for="nombre" class="form-control" />
    </div>
    <div class="form-group">
        <label>Cantidad</label>
        <input asp-for="cantidad" class="form-control" />
    </div>
    <div class="form-group">
        <label>Especie</label>
        @{
            var especieSelectList = new SelectList(Model.especies, "idEspecie", "nombreComun");
        }
        <select asp-for="idEspecie" class="form-control" asp-items="especieSelectList">
            <option value="">Seleccione una especie</option>
        </select>
    </div>
    <div class="form-group">
        <label>Ubicación</label>
        @{
            var ubicacionSelectList = new SelectList(Model.ubicaciones, "idUbicacion", "nombre");
        }
        <select asp-for="idUbicacion" class="form-control" asp-items="ubicacionSelectList">
            <option value="">Seleccione una ubicación</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Guardar</button>
</form>
<div id="mensaje" class="mt-3"></div>

@section Scripts {
    <script>
        document.getElementById('EditarSemilla').addEventListener('submit', async function(e) {
            e.preventDefault();

            const mensajeDiv = document.getElementById('mensaje');
            mensajeDiv.innerHTML = '';

            const formData = new FormData(this);
            const semillaData = {
                idSemilla: parseInt(formData.get('idSemilla')),
                nombre: formData.get('nombre'),
                idEspecie: parseInt(formData.get('idEspecie')),
                idUbicacion: parseInt(formData.get('idUbicacion')),
                cantidad: parseInt(formData.get('cantidad'))
            };

            const API_BASE_URL = "@Configuration["AppSettings:ApiBaseUrl"]";
            const apiUrl = `${API_BASE_URL}/api/Semillas/${semillaData.idSemilla}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(semillaData)
                });

                if (response.ok) {
                    mensajeDiv.className = 'alert alert-success';
                    mensajeDiv.innerHTML = `Semilla '${semillaData.nombre}' actualizada exitosamente con ID: ${semillaData.idSemilla}.`;
                    setTimeout(() => {
                        window.location.href = '/Semillas/Index';
                    }, 3000);
                } else {
                    const errorData = await response.json();
                    mensajeDiv.className = 'alert alert-danger';
                    let errorMessage = 'Error al actualizar semilla: ';
                    if (errorData.errors) {
                        for (const key in errorData.errors) {
                            errorMessage += `${key}: ${errorData.errors[key].join(', ')} `;
                        }
                    } else {
                        errorMessage += errorData.title || errorData.detail || JSON.stringify(errorData);
                    }
                    mensajeDiv.innerHTML = errorMessage;
                    console.error('Error del API:', errorData);
                }
            } catch (error) {
                console.error('Error de red al guardar la semilla:', error);
                mensajeDiv.className = 'alert alert-danger';
                mensajeDiv.innerHTML = `Ocurrió un error de red: ${error.message}. Asegúrate de que la API está corriendo y las configuraciones de CORS son correctas.`;
            }
        });
    </script>
}

