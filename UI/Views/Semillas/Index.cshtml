@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

@{
    ViewData["Title"] = "Gestión de Semillas";
}

<h1>Gestión de Semillas</h1>

<div style="text-align: right;">
    <button class="btn btn-sm btn-success">
        <a class="nav-link text-dark" asp-area="" asp-controller="Ubicaciones" asp-action="Agregar">Agregar Ubicación</a>
    </button>
    <button class="btn btn-sm btn-success">
        <a class="nav-link text-dark" asp-area="" asp-controller="Semillas" asp-action="Agregar">Agregar Semilla</a>
    </button>
</div>

<div id="mensajeListaSemillas" class="mt-3"></div>

<table id="semillasTable" class="table table-striped table-hover">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Especie</th>
            <th>Ubicación</th>
            <th>Cantidad</th>
            <th>Fecha de almacenamiento</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="semillasTableBody">
    </tbody>
</table>
@section Scripts {
    <script>
        const API_BASE_URL = "@Configuration["AppSettings:ApiBaseUrl"]";
        const API_SEMILLAS_URL = `${API_BASE_URL}/api/Semillas`;
        const semillasTableBody = document.getElementById('semillasTableBody');
        const mensajeListaSemillas = document.getElementById('mensajeListaSemillas');

        async function loadSemillas() {
            try {
                // Llama al endpoint de tu API para obtener las semillas
                const response = await fetch(`${API_SEMILLAS_URL}`);

                if (response.ok) {
                    const semillas = await response.json();
                    semillasTableBody.innerHTML = '';

                    if (semillas.length === 0) {
                        mensajeListaSemillas.className = 'alert alert-info';
                        mensajeListaSemillas.innerHTML = 'No se encontraron semillas.';
                        return;
                    }

                    semillas.forEach(semilla => {
                        const row = `
                            <tr>
                                <td>${semilla.idSemilla}</td>
                                <td>${semilla.nombre}</td>
                                <td>${semilla.especie.nombre}</td>
                                <td>${semilla.ubicacion.nombre}</td>
                                <td>${semilla.cantidad}</td>
                                <td>${semilla.fechaAlmacenamiento}</td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-semilla" data-id="${semilla.idSemilla}">Editar</button>
                                    <button class="btn btn-sm btn-danger delete-semilla" data-id="${semilla.idSemilla}">Eliminar</button>
                                </td>
                            </tr>
                        `;
                        semillasTableBody.innerHTML += row;
                    });

                    // Configura los eventos de los botones "Editar"
                    document.querySelectorAll('.edit-semilla').forEach(button => {
                        button.addEventListener('click', function() {
                            const semillaId = this.dataset.id;
                            // Redirigir a la vista de edición
                            window.location.href = `/Semillas/Editar/${semillaId}`;
                        });
                    });

                    // Configura los eventos de los botones "Eliminar"
                    document.querySelectorAll('.delete-semilla').forEach(button => {
                        button.addEventListener('click', async function() {
                            const semillaId = this.dataset.id;

                            // Muestra la ventana de confirmación
                            const confirmacion = confirm("¿Estás seguro de que deseas eliminar esta semilla?");

                            if (confirmacion) {
                                try {
                                    // Realiza la petición DELETE al API
                                    const API_BASE_URL = "@Configuration["AppSettings:ApiBaseUrl"]";
                                    const apiUrl = `${API_BASE_URL}/api/Semillas/${semillaId}`;

                                    const response = await fetch(apiUrl, {
                                        method: 'DELETE'
                                    });

                                    if (response.ok) {
                                        alert('Semilla eliminada exitosamente.');
                                        // Recarga la página para mostrar los cambios
                                        window.location.reload();
                                    } else {
                                        const errorData = await response.json();
                                        alert('Error al eliminar la semilla: ' + JSON.stringify(errorData));
                                        console.error('Error del API:', errorData);
                                    }
                                } catch (error) {
                                    console.error('Error de red al eliminar la semilla:', error);
                                    alert('Ocurrió un error de red.');
                                }
                            }
                        });
                    });

                } else {
                    mensajeListaSemillas.className = 'alert alert-danger';
                    mensajeListaSemillas.innerHTML = 'Error al cargar semillas.';
                }
            } catch (error) {
                mensajeListaSemillas.className = 'alert alert-danger';
                mensajeListaSemillas.innerHTML = `Ocurrió un error de red: ${error.message}.`;
            }
        }

        loadSemillas();
    </script>
}

